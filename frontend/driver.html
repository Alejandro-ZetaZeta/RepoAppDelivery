<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Delivery - Panel Motorizado</title>
    <!-- SCRIPT DE SEGURIDAD -->
    <script>
        const userId = localStorage.getItem('userId');
        const userRole = localStorage.getItem('userRole');
        if (!userId || userRole !== 'motorizado') { window.location.href = 'index.html'; }
    </script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="css/style.css">
    <!-- Fuente Inter para mejor legibilidad -->
    <script src="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"></script>
    <!-- FontAwesome para iconos con aria-hidden -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Mejora del foco para accesibilidad */
        *:focus-visible {
            outline: 3px solid #3B82F6;
            outline-offset: 2px;
        }
    </style>
</head>
<!-- Fondo oscuro con gradiente sutil para reducir fatiga visual -->
<body class="bg-gray-900 min-h-screen flex items-center justify-center p-4">

    <main class="w-full max-w-md" role="main">
        <!-- Tarjeta principal con alto contraste: Fondo gris oscuro (gray-800) -->
        <div class="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-700">
            
            <header class="mb-6 border-b border-gray-700 pb-4">
                <h1 class="text-2xl font-bold text-white mb-2 flex items-center">
                    <i class="fas fa-motorcycle text-emerald-400 mr-3" aria-hidden="true"></i>
                    Panel Motorizado
                </h1>
                <p class="text-gray-300">
                    Hola, <span id="driverName" class="font-semibold text-white">Conductor</span>
                </p>
            </header>
            
            <!-- Región en vivo para lectores de pantalla -->
            <div id="servicio-asignado-panel" class="mt-4" aria-live="polite">
                <div class="animate-pulse flex space-x-4">
                    <div class="flex-1 space-y-4 py-1">
                        <div class="h-4 bg-gray-700 rounded w-3/4"></div>
                        <div class="space-y-2">
                            <div class="h-4 bg-gray-700 rounded"></div>
                            <div class="h-4 bg-gray-700 rounded w-5/6"></div>
                        </div>
                    </div>
                </div>
            </div>

            <button id="logoutButton" class="w-full mt-8 bg-red-600 text-white p-4 rounded-xl font-bold hover:bg-red-700 transition focus:ring-4 focus:ring-red-900 flex items-center justify-center group" aria-label="Cerrar sesión">
                <i class="fas fa-sign-out-alt mr-2 group-hover:-translate-x-1 transition-transform" aria-hidden="true"></i>
                Cerrar Sesión
            </button>
        </div>
    </main>
    
    <!-- Modal Accesible -->
    <div id="messageModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm transition-opacity" aria-hidden="true"></div>
        <div class="relative bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm p-6 border border-gray-600">
            <h3 id="modalTitle" class="text-xl font-bold text-white mb-2"></h3>
            <p id="modalMessage" class="text-gray-300 mb-6 text-lg"></p>
            <button id="modalCloseButton" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 focus:ring-4 focus:ring-blue-800 transition">
                Entendido
            </button>
        </div>
    </div>

    <script>
        const API_URL = 'https://tugless-eryn-forlornly.ngrok-free.dev';
        let currentServiceId = null;
        let motorizadoId = localStorage.getItem('userId');

        // Fetch Helper
        async function fetchAPI(endpoint, options = {}) {
            const headers = { 'ngrok-skip-browser-warning': 'true', 'Content-Type': 'application/json', ...options.headers };
            const response = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            return await response.json();
        }

        // Modal Logic
        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            
            const closeBtn = document.getElementById('modalCloseButton');
            closeBtn.disabled = false; // <--- CORRECCIÓN IMPORTANTE: Aseguramos que esté habilitado
            
            const modal = document.getElementById('messageModal');
            modal.classList.remove('hidden');
            
            closeBtn.focus();
        }
        
        document.getElementById('modalCloseButton').onclick = () => {
            document.getElementById('messageModal').classList.add('hidden');
        };

        async function cargarMiServicio() {
            const panel = document.getElementById('servicio-asignado-panel');
            
            try {
                const servicio = await fetchAPI(`/api/servicios/motorizado/${motorizadoId}`);
                
                if (!servicio) {
                    panel.innerHTML = `
                        <div class="text-center py-10 bg-gray-700/50 rounded-xl border-2 border-dashed border-gray-600">
                            <i class="fas fa-mug-hot text-4xl text-gray-500 mb-3" aria-hidden="true"></i>
                            <p class="text-emerald-400 font-bold text-xl mb-2">¡Estás libre!</p>
                            <p class="text-gray-400">Espera nuevas asignaciones.</p>
                        </div>`;
                    return;
                }
                
                currentServiceId = servicio.id;
                
                // Diseño de Tarjeta de Pedido Activo
                panel.innerHTML = `
                    <article class="bg-gray-700 p-5 rounded-xl border border-gray-600 shadow-lg">
                        <div class="flex justify-between items-start mb-4 border-b border-gray-600 pb-4">
                            <div>
                                <span class="text-xs font-bold text-blue-300 uppercase tracking-wider">Pedido Actual</span>
                                <h2 class="text-2xl font-bold text-white">#${servicio.id}</h2>
                            </div>
                            <div class="bg-blue-900 text-blue-200 px-3 py-1 rounded-full text-xs font-bold border border-blue-700">
                                EN PROCESO
                            </div>
                        </div>

                        <div class="space-y-4 mb-6">
                            <div>
                                <p class="text-xs text-gray-400 uppercase font-bold mb-1">Cliente</p>
                                <div class="flex items-center text-white">
                                    <i class="fas fa-user-circle text-gray-400 mr-2" aria-hidden="true"></i>
                                    <span class="text-lg">${servicio.nombre} ${servicio.apellido}</span>
                                </div>
                            </div>

                            <div class="bg-gray-800 p-3 rounded-lg border-l-4 border-yellow-500">
                                <p class="text-xs text-yellow-500 uppercase font-bold mb-1">Recoger en (A)</p>
                                <p class="text-white font-medium text-lg leading-tight">${servicio.punto_a}</p>
                            </div>

                            <div class="bg-gray-800 p-3 rounded-lg border-l-4 border-emerald-500">
                                <p class="text-xs text-emerald-500 uppercase font-bold mb-1">Entregar en (B)</p>
                                <p class="text-white font-medium text-lg leading-tight">${servicio.punto_b}</p>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <p class="text-sm font-bold text-gray-300 mb-3" id="status-label">Actualizar Estado:</p>
                            <div class="grid grid-cols-1 gap-3" role="group" aria-labelledby="status-label">
                                <!-- Botones de estado -->
                                <button onclick="actualizar('recogiendo')" 
                                    class="status-btn py-4 px-4 rounded-xl font-bold text-lg transition flex items-center justify-center
                                    ${servicio.estado_servicio === 'recogiendo' 
                                        ? 'bg-blue-600 text-white ring-2 ring-white ring-offset-2 ring-offset-gray-800 cursor-default' 
                                        : 'bg-blue-900/50 text-blue-200 hover:bg-blue-800 border border-blue-700'}">
                                    <i class="fas fa-box-open mr-2"></i> Recogiendo
                                </button>

                                <button onclick="actualizar('en camino')" 
                                    class="status-btn py-4 px-4 rounded-xl font-bold text-lg transition flex items-center justify-center
                                    ${servicio.estado_servicio === 'en camino' 
                                        ? 'bg-yellow-500 text-black ring-2 ring-white ring-offset-2 ring-offset-gray-800 cursor-default' 
                                        : 'bg-yellow-900/40 text-yellow-200 hover:bg-yellow-800 border border-yellow-700'}">
                                    <i class="fas fa-route mr-2"></i> En Camino
                                </button>

                                <button onclick="actualizar('entregado')" 
                                    class="status-btn py-4 px-4 rounded-xl bg-emerald-600 text-white font-bold text-lg hover:bg-emerald-500 border border-emerald-500 shadow-lg hover:shadow-emerald-500/20 transition flex items-center justify-center">
                                    <i class="fas fa-check-circle mr-2"></i> ¡ENTREGADO!
                                </button>
                            </div>
                        </div>
                    </article>
                `;
            } catch (error) { 
                console.error(error);
                panel.innerHTML = `
                    <div class="bg-red-900/20 border border-red-500 text-red-200 p-4 rounded-lg text-center">
                        <p class="font-bold">Error de conexión</p>
                        <button onclick="cargarMiServicio()" class="mt-2 text-sm underline hover:text-white">Reintentar</button>
                    </div>`; 
            }
        }

        async function actualizar(nuevoEstado) {
            try {
                // CORRECCIÓN: Solo deshabilitar los botones de estado del panel, NO el del modal
                const statusButtons = document.querySelectorAll('.status-btn');
                statusButtons.forEach(b => b.disabled = true);

                const res = await fetchAPI('/api/servicios/actualizar', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        id_servicio: currentServiceId, 
                        id_motorizado: motorizadoId, 
                        nuevo_estado: nuevoEstado 
                    })
                });
                
                if (res.success) { 
                    showModal('¡Estado Actualizado!', `El pedido ahora está: ${nuevoEstado.toUpperCase()}`); 
                    cargarMiServicio(); 
                }
            } catch (e) { 
                showModal('Error', e.message);
                cargarMiServicio(); // Restaurar estado
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('driverName').textContent = localStorage.getItem('userName') || 'Motorizado';
            document.getElementById('logoutButton').onclick = () => { 
                localStorage.clear(); 
                window.location.href = 'index.html'; 
            };
            cargarMiServicio();
        });
    </script>
</body>
</html>