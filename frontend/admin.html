<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Delivery</title>
    <script>
        const userId = localStorage.getItem('userId');
        const userRole = localStorage.getItem('userRole');
        if (!userId || userRole !== 'admin') {
            window.location.href = 'index.html';
        }
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid #FBBF24;
        }
        /* Sidebar Móvil Mejorado */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }
        @media (min-width: 768px) { #sidebar { transform: translateX(0); } }
        #sidebar.open { transform: translateX(0); }
    </style>
</head>
<body class="bg-gray-100 h-screen flex overflow-hidden">

    <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden transition-opacity"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-gradient-to-b from-purple-900 to-indigo-900 text-white flex flex-col shadow-2xl h-full md:relative">
        <div class="p-6 flex items-center justify-between border-b border-purple-800">
            <div class="flex items-center justify-center w-full">
                <i class="fas fa-rocket text-3xl mr-3 text-yellow-400"></i>
                <h1 class="text-2xl font-bold tracking-wider">DELIVERY<span class="text-yellow-400">APP</span></h1>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-white hover:text-gray-300 focus:outline-none p-2">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center px-4 py-3 text-purple-100 hover:bg-purple-800 rounded-r-xl transition-all duration-200 text-left active"><i class="fas fa-tachometer-alt w-6"></i><span class="font-medium">Panel Principal</span></button>
            <button onclick="switchTab('motorizados')" id="nav-motorizados" class="nav-item w-full flex items-center px-4 py-3 text-purple-100 hover:bg-purple-800 rounded-r-xl transition-all duration-200 text-left"><i class="fas fa-motorcycle w-6"></i><span>Motorizados</span></button>
            <button onclick="switchTab('clientes')" id="nav-clientes" class="nav-item w-full flex items-center px-4 py-3 text-purple-100 hover:bg-purple-800 rounded-r-xl transition-all duration-200 text-left"><i class="fas fa-users w-6"></i><span>Clientes</span></button>
            <button onclick="switchTab('avisos')" id="nav-avisos" class="nav-item w-full flex items-center px-4 py-3 text-purple-100 hover:bg-purple-800 rounded-r-xl transition-all duration-200 text-left"><i class="fas fa-bullhorn w-6"></i><span>Publicar Avisos</span></button>
        </nav>
        <div class="p-4 border-t border-purple-800">
            <button id="logoutButton" class="flex items-center w-full px-4 py-2 text-red-300 hover:text-white hover:bg-red-600 rounded-lg transition duration-200"><i class="fas fa-sign-out-alt w-6"></i><span>Cerrar Sesión</span></button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative w-full">
        <header class="bg-white shadow-sm h-16 flex items-center justify-between px-4 md:px-8 z-10">
            <div class="flex items-center text-gray-500">
                <button onclick="toggleSidebar()" class="mr-4 md:hidden focus:outline-none text-gray-600 hover:text-purple-700 p-2 rounded"><i class="fas fa-bars text-2xl"></i></button>
                <h2 class="text-xl font-semibold text-gray-800" id="header-title">Dashboard de Control</h2>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right hidden sm:block"><p class="text-xs text-gray-400 uppercase font-bold">Bienvenido</p><p class="text-sm font-bold text-purple-700" id="adminName">Admin Global</p></div>
                <div class="h-10 w-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 border border-purple-200"><i class="fas fa-user-shield"></i></div>
            </div>
        </header>

        <div class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-4 md:p-8 relative">
            <div id="view-dashboard" class="view-section fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center"><div class="p-4 rounded-full bg-orange-50 text-orange-500 mr-4"><i class="fas fa-bell text-2xl"></i></div><div><p class="text-gray-400 text-xs font-bold uppercase">Pedidos Pendientes</p><p class="text-3xl font-bold text-gray-800" id="stats-pendientes">0</p></div></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center"><div class="p-4 rounded-full bg-green-50 text-green-500 mr-4"><i class="fas fa-motorcycle text-2xl"></i></div><div><p class="text-gray-400 text-xs font-bold uppercase">Motorizados Activos</p><p class="text-3xl font-bold text-gray-800" id="stats-motorizados">0</p></div></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center"><div class="p-4 rounded-full bg-blue-50 text-blue-500 mr-4"><i class="fas fa-users text-2xl"></i></div><div><p class="text-gray-400 text-xs font-bold uppercase">Total Clientes</p><p class="text-3xl font-bold text-gray-800" id="stats-clientes">0</p></div></div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center"><h3 class="text-lg font-bold text-purple-900"><i class="fas fa-list-ul mr-2"></i>Solicitudes Recientes</h3><button onclick="cargarServiciosPendientes()" class="text-sm text-purple-600 font-medium hover:underline"><i class="fas fa-sync-alt mr-1"></i> Actualizar</button></div>
                    <div class="p-6 bg-gray-50"><div id="servicios-pendientes-list" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div></div>
                </div>
            </div>

            <div id="view-motorizados" class="view-section hidden fade-in">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white flex-wrap gap-2">
                        <h3 class="text-lg font-bold text-gray-800">Flota de Motorizados</h3>
                        <div class="flex space-x-2"><button onclick="abrirModalCrearMotorizado()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md transition transform hover:scale-105"><i class="fas fa-plus mr-1"></i> Nuevo Motorizado</button><button onclick="cargarTablaMotorizados()" class="bg-purple-100 text-purple-700 px-4 py-2 rounded-lg text-sm font-bold hover:bg-purple-200"><i class="fas fa-sync-alt"></i></button></div>
                    </div>
                    <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="bg-gray-50 text-gray-600 text-sm uppercase tracking-wider"><th class="p-4 font-semibold border-b">ID</th><th class="p-4 font-semibold border-b">Nombre</th><th class="p-4 font-semibold border-b">Estado</th><th class="p-4 font-semibold border-b text-right">Acciones</th></tr></thead><tbody id="tabla-motorizados-body" class="text-sm text-gray-700"></tbody></table></div>
                </div>
            </div>

            <div id="view-clientes" class="view-section hidden fade-in">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800">Directorio de Clientes</h3><button onclick="cargarTablaClientes()" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-100"><i class="fas fa-sync-alt mr-1"></i> Actualizar Lista</button></div>
                    <div class="p-0"><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50"><tr><th class="p-4 text-xs font-bold text-gray-500 uppercase border-b">ID</th><th class="p-4 text-xs font-bold text-gray-500 uppercase border-b">Nombre Completo</th><th class="p-4 text-xs font-bold text-gray-500 uppercase border-b">Cédula</th><th class="p-4 text-xs font-bold text-gray-500 uppercase border-b">Teléfono</th><th class="p-4 text-xs font-bold text-gray-500 uppercase border-b">Email</th></tr></thead><tbody id="tabla-clientes-body" class="text-sm text-gray-700"></tbody></table></div></div>
                </div>
            </div>

            <div id="view-avisos" class="view-section hidden fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-8 rounded-3xl shadow-xl border border-purple-100">
                        <div class="flex items-center mb-6"><div class="p-3 bg-pink-100 rounded-full text-pink-600 mr-4"><i class="fas fa-bullhorn text-xl"></i></div><div><h3 class="text-xl font-bold text-gray-900">Crear Nuevo Aviso</h3><p class="text-sm text-gray-500">Este mensaje aparecerá a todos los clientes.</p></div></div>
                        <form id="formAviso" class="space-y-4">
                            <div><label class="block text-sm font-bold text-gray-700 mb-1">Título del Aviso</label><input type="text" id="avisoTitulo" placeholder="Ej: ¡Descuentos!" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 outline-none"></div>
                            <div><label class="block text-sm font-bold text-gray-700 mb-1">Mensaje</label><textarea id="avisoMensaje" rows="4" placeholder="Contenido..." required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 outline-none"></textarea></div>
                            <div class="flex items-center justify-between"><div class="flex items-center"><input type="checkbox" id="avisoActivo" class="w-5 h-5 text-pink-600 rounded" checked onchange="toggleFechaAviso()"><label for="avisoActivo" class="ml-2 text-sm font-medium text-gray-700">Mostrar inmediatamente</label></div></div>
                            <div id="containerFechaAviso" class="hidden animate-fade-in-down"><label class="block text-sm font-bold text-gray-700 mb-1">Programar para:</label><input type="datetime-local" id="avisoFecha" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 outline-none"></div>
                            <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-purple-600 text-white py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition">Publicar Aviso</button>
                        </form>
                    </div>
                    <div class="bg-gray-50 p-8 rounded-3xl border-2 border-dashed border-gray-200 flex flex-col items-center justify-center text-center">
                        <p class="text-gray-400 font-bold mb-4 uppercase text-xs tracking-wider">Vista Previa</p>
                        <div class="bg-white p-6 rounded-2xl shadow-lg max-w-sm w-full border-l-4 border-pink-500">
                            <h4 class="text-lg font-bold text-gray-900 mb-2" id="previewTitulo">Título</h4>
                            <p class="text-sm text-gray-600" id="previewMensaje">Contenido...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="messageModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden"><div class="fixed inset-0 bg-gray-900 bg-opacity-50 transition-opacity"></div><div class="relative bg-white rounded-2xl shadow-xl w-full max-w-sm p-6"><h3 id="modalTitle" class="font-bold text-lg mb-2 text-gray-900"></h3><p id="modalMessage" class="text-gray-600 mb-6"></p><button id="modalCloseButton" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold">Entendido</button></div></div>
    <div id="assignModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden"><div class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm"></div><div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden"><div class="bg-purple-700 p-4 text-white"><h3 class="font-bold">Asignar Motorizado</h3></div><div class="p-6"><p class="text-sm text-gray-500 mb-2">Pedido #<span id="assign-service-id"></span></p><p class="font-bold text-gray-800 mb-4" id="assign-client-name"></p><div id="assign-motorizado-list" class="space-y-2 max-h-60 overflow-y-auto"></div></div><div class="bg-gray-50 p-3 flex justify-end border-t"><button id="assignModalCloseButton" class="text-gray-500 font-bold px-4">Cancelar</button></div></div></div>
    <div id="createDriverModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden"><div class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm"></div><div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden"><div class="bg-blue-600 p-4 text-white flex justify-between items-center shrink-0"><h3 class="font-bold text-lg" id="modalDriverTitle"></h3><button onclick="cerrarModalCrearMotorizado()" class="text-blue-200 hover:text-white"><i class="fas fa-times"></i></button></div><div class="p-6 overflow-y-auto"><form id="createDriverForm" class="space-y-4"><input type="hidden" id="driverIdEdit"> <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Nombre</label><input type="text" id="newDriverNombre" required class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50"></div><div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Apellido</label><input type="text" id="newDriverApellido" required class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50"></div></div><div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Cédula</label><input type="text" id="newDriverCedula" required class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50"></div><div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Teléfono</label><input type="tel" id="newDriverTelefono" required class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50"></div><div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Fecha de Nacimiento</label><input type="date" id="newDriverNacimiento" required class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50"></div><div class="border-t pt-4"><p class="text-xs text-blue-600 font-bold mb-2 uppercase">Credenciales de Acceso</p><div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Correo (Usuario)</label><input type="email" id="newDriverEmail" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div><div class="mt-2"><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Contraseña</label><input type="password" id="newDriverPassword" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="***"></div></div><div class="flex justify-between items-center pt-4"><button type="button" id="btnDeleteDriver" onclick="eliminarMotorizado()" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-200 hidden"><i class="fas fa-trash mr-2"></i> Eliminar</button><button type="submit" id="btnSaveDriver" class="flex-1 ml-3 bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg"><i class="fas fa-save mr-2"></i> Guardar</button></div></form></div></div></div>
    
    <script>
        const API_URL = 'https://tugless-eryn-forlornly.ngrok-free.dev'; 

        async function fetchAPI(endpoint, options = {}) {
            const headers = { 'ngrok-skip-browser-warning': 'true', 'Content-Type': 'application/json', ...options.headers };
            const response = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            return await response.json();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('hidden');
        }

        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('messageModal').classList.remove('hidden');
        }
        document.getElementById('modalCloseButton').addEventListener('click', () => document.getElementById('messageModal').classList.add('hidden'));

        function switchTab(tabName) {
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('mobile-overlay').classList.add('hidden');
            }
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            document.getElementById(`nav-${tabName}`).classList.add('active');
            
            if(tabName === 'motorizados') cargarTablaMotorizados();
            if(tabName === 'clientes') cargarTablaClientes();
        }

        function toggleFechaAviso() {
            const inmediato = document.getElementById('avisoActivo').checked;
            const container = document.getElementById('containerFechaAviso');
            if (inmediato) container.classList.add('hidden');
            else container.classList.remove('hidden');
        }

        // --- DATOS ---
        async function cargarServiciosPendientes() {
            const list = document.getElementById('servicios-pendientes-list');
            try {
                const data = await fetchAPI('/api/servicios/pendientes');
                document.getElementById('stats-pendientes').textContent = data.length;
                list.innerHTML = '';
                if(data.length === 0) { list.innerHTML = '<div class="col-span-2 text-center text-gray-400 py-8">Sin pendientes.</div>'; return; }
                data.forEach(s => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-xl shadow border border-gray-200';
                    card.innerHTML = `
                        <div class="flex justify-between mb-2"><span class="font-bold text-gray-800">Pedido #${s.id}</span><button onclick="asignar(${s.id}, '${s.nombre} ${s.apellido}')" class="bg-purple-100 text-purple-600 px-3 rounded-full text-xs font-bold hover:bg-purple-600 hover:text-white transition">Asignar</button></div>
                        <p class="text-sm text-gray-600 truncate"><i class="fas fa-map-marker-alt text-red-400"></i> ${s.punto_a}</p>
                        <p class="text-sm text-gray-600 truncate"><i class="fas fa-flag text-green-400"></i> ${s.punto_b}</p>
                    `;
                    list.appendChild(card);
                });
            } catch (e) { console.error(e); }
        }

        function abrirModalCrearMotorizado() {
            document.getElementById('createDriverForm').reset();
            document.getElementById('driverIdEdit').value = "";
            document.getElementById('modalDriverTitle').innerHTML = '<i class="fas fa-user-plus mr-2"></i>Contratar Motorizado';
            ['newDriverNombre', 'newDriverApellido', 'newDriverCedula', 'newDriverTelefono', 'newDriverNacimiento'].forEach(id => {
                const el = document.getElementById(id);
                el.disabled = false;
                el.classList.remove('bg-gray-200', 'text-gray-500');
                el.classList.add('bg-white');
            });
            document.getElementById('btnDeleteDriver').classList.add('hidden');
            document.getElementById('createDriverModal').classList.remove('hidden');
        }

        window.abrirModalEditarMotorizado = function(motoString) {
            const moto = JSON.parse(decodeURIComponent(motoString));
            document.getElementById('newDriverNombre').value = moto.nombre;
            document.getElementById('newDriverApellido').value = moto.apellido;
            document.getElementById('newDriverCedula').value = moto.cedula;
            document.getElementById('newDriverTelefono').value = moto.telefono;
            document.getElementById('newDriverEmail').value = moto.correo;
            if(moto.fecha_nacimiento) document.getElementById('newDriverNacimiento').value = new Date(moto.fecha_nacimiento).toISOString().split('T')[0];
            
            ['newDriverNombre', 'newDriverApellido', 'newDriverCedula', 'newDriverTelefono', 'newDriverNacimiento'].forEach(id => {
                const el = document.getElementById(id);
                el.disabled = true;
                el.classList.add('bg-gray-200', 'text-gray-500');
                el.classList.remove('bg-white');
            });

            document.getElementById('driverIdEdit').value = moto.id;
            document.getElementById('modalDriverTitle').innerHTML = '<i class="fas fa-user-edit mr-2"></i>Editar Credenciales';
            document.getElementById('btnDeleteDriver').classList.remove('hidden');
            document.getElementById('createDriverModal').classList.remove('hidden');
        };

        async function eliminarMotorizado() {
            const id = document.getElementById('driverIdEdit').value;
            if(!confirm('¿Estás seguro? Esta acción es irreversible.')) return;
            try {
                const res = await fetchAPI(`/api/usuarios/${id}`, { method: 'DELETE' });
                if(res.success) {
                    cerrarModalCrearMotorizado();
                    showModal('Eliminado', 'Usuario eliminado.');
                    cargarTablaMotorizados();
                } else { showModal('Error', res.message); }
            } catch(e) { showModal('Error', e.message); }
        }

        document.getElementById('createDriverForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('driverIdEdit').value;
            const isEdit = id !== "";
            const url = isEdit ? `/api/usuarios/${id}` : '/api/usuarios';
            const method = isEdit ? 'PUT' : 'POST';
            const data = {
                nombre: document.getElementById('newDriverNombre').value,
                apellido: document.getElementById('newDriverApellido').value,
                cedula: document.getElementById('newDriverCedula').value,
                telefono: document.getElementById('newDriverTelefono').value,
                fecha_nacimiento: document.getElementById('newDriverNacimiento').value,
                correo: document.getElementById('newDriverEmail').value,
                password: document.getElementById('newDriverPassword').value,
                rol: 'motorizado',
                estado: 'disponible'
            };
            try {
                const res = await fetchAPI(url, { method, body: JSON.stringify(data) });
                if(res.success) {
                    cerrarModalCrearMotorizado();
                    showModal('Éxito', isEdit ? 'Actualizado.' : 'Creado.');
                    cargarTablaMotorizados();
                } else { showModal('Error', res.message); }
            } catch(e) { showModal('Error', e.message); }
        });

        function cerrarModalCrearMotorizado() { document.getElementById('createDriverModal').classList.add('hidden'); }

        async function cargarTablaMotorizados() {
            const tbody = document.getElementById('tabla-motorizados-body');
            try {
                const data = await fetchAPI('/api/motorizados');
                document.getElementById('stats-motorizados').textContent = data.length;
                tbody.innerHTML = '';
                data.forEach(m => {
                    const motoString = encodeURIComponent(JSON.stringify(m));
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="p-4 font-mono text-xs">#${m.id}</td>
                        <td class="p-4 font-bold text-gray-700">${m.nombre} ${m.apellido}</td>
                        <td class="p-4"><span class="px-2 py-1 rounded-full text-xs font-bold ${m.estado==='disponible'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${m.estado.toUpperCase()}</span></td>
                        <td class="p-4 text-right"><button onclick="abrirModalEditarMotorizado('${motoString}')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(e) { console.error(e); }
        }

        async function cargarTablaClientes() {
            const tbody = document.getElementById('tabla-clientes-body');
            try {
                const data = await fetchAPI('/api/clientes');
                document.getElementById('stats-clientes').textContent = data.length;
                tbody.innerHTML = '';
                data.forEach(c => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="p-4 text-xs">#${c.id}</td><td class="p-4 font-bold">${c.nombre} ${c.apellido}</td><td class="p-4 text-gray-500 text-xs">${c.cedula}</td><td class="p-4 text-gray-500 text-xs">${c.telefono}</td><td class="p-4 text-blue-500 text-xs">${c.correo}</td>`;
                    tbody.appendChild(tr);
                });
            } catch(e) { console.error(e); }
        }

        const assignModal = document.getElementById('assignModal');
        const assignList = document.getElementById('assign-motorizado-list');
        window.asignar = async (serviceId, clientName) => {
            document.getElementById('assign-service-id').textContent = serviceId;
            document.getElementById('assign-client-name').textContent = clientName;
            assignModal.classList.remove('hidden');
            assignList.innerHTML = 'Cargando...';
            try {
                const motos = await fetchAPI('/api/motorizados');
                const disponibles = motos.filter(m => m.estado === 'disponible');
                assignList.innerHTML = '';
                if(disponibles.length === 0) { assignList.innerHTML = '<p class="text-red-500 text-center text-sm">No hay motorizados disponibles.</p>'; return; }
                disponibles.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer mb-2';
                    div.innerHTML = `<span class="font-bold text-sm">${m.nombre} ${m.apellido}</span><button class="text-xs bg-purple-600 text-white px-3 py-1 rounded">Elegir</button>`;
                    div.onclick = async () => {
                        await fetchAPI('/api/servicios/asignar', { method: 'POST', body: JSON.stringify({ id_servicio: serviceId, id_motorizado: m.id }) });
                        assignModal.classList.add('hidden');
                        showModal('Éxito', 'Asignado correctamente');
                        cargarServiciosPendientes();
                    };
                    assignList.appendChild(div);
                });
            } catch(e) { console.error(e); }
        };
        document.getElementById('assignModalCloseButton').onclick = () => assignModal.classList.add('hidden');

        document.getElementById('formAviso').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inmediato = document.getElementById('avisoActivo').checked;
            let fecha = null;
            if (!inmediato) {
                fecha = document.getElementById('avisoFecha').value;
                if (!fecha) { showModal('Error', 'Selecciona fecha.'); return; }
            }
            const aviso = {
                titulo: document.getElementById('avisoTitulo').value,
                mensaje: document.getElementById('avisoMensaje').value,
                activo: true,
                fecha_programada: fecha
            };
            try {
                const data = await fetchAPI('/api/avisos', { method: 'POST', body: JSON.stringify(aviso) });
                if (data.success) {
                    showModal('Aviso Publicado', 'Mensaje programado.');
                    e.target.reset();
                    toggleFechaAviso();
                }
            } catch (err) { console.error(err); showModal('Error', 'No se pudo publicar.'); }
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('adminName').textContent = localStorage.getItem('userName') || 'Admin';
            document.getElementById('logoutButton').onclick = () => { localStorage.clear(); window.location.href = 'index.html'; };
            cargarServiciosPendientes();
            cargarTablaMotorizados();
            cargarTablaClientes();

            // Setup listeners for preview
            const tit = document.getElementById('avisoTitulo');
            const msg = document.getElementById('avisoMensaje');
            if(tit) tit.addEventListener('input', (e) => document.getElementById('previewTitulo').textContent = e.target.value || 'Título');
            if(msg) msg.addEventListener('input', (e) => document.getElementById('previewMensaje').textContent = e.target.value || 'Contenido...');
        });
    </script>
</body>
</html>